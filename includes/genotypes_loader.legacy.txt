<?php
/**
 * @file
 * Provides functionality for loading a legacy file.
 */

/**
 * Parses a tab-delimited file and inserts markers, variants, and genotype calls into the database.
 *
 * @param $input_file
 *   The absolute path of the file to be parsed.
 * @param $sample_file
 *   The absolute path of a tab-delimited file specifying the samples in the input file and
 *   their associated stock name, stock accession, germplasm name and germplasm accession.
 * @param $options
 *   An associative array of additional information. Keys include:
 *     - organism_id: the organism_id of both the marker/variants and samples/germplasm.
 *     - variant_type: the cvterm.name of the feature.type_id for the variant.
 *     - feature_type_of_marker: the cvterm_name of the feature.type_id for the marker.
 *     - marker_type: the cvterm.name of the feature.type_id for the marker.
 *     - project_name: the name of the project.
 *     - storage_method: the method to use when storing the genotypes;
 *        one of nd_exp, genotype_call, stock_genotype.
 *     - insert_samples: whether to insert the sample record if it doesn't already exist;
 *        one of 0: Select Only, 1: Insert Only, 2: Insert & Select.
 *     - insert_germplasm: whether to insert the germplasm record if it doesn't already exist;
 *        one of 0: Select Only, 1: Insert Only, 2: Insert & Select.
 *     - insert_markers: whether to insert the marker record if it doesn't already exist;
 *        one of 0: Select Only, 1: Insert Only, 2: Insert & Select.
 *     - insert_variants: whether to insert the variant record if it doesn't already exist;
 *        one of 0: Select Only, 1: Insert Only, 2: Insert & Select.
 *     - nd_geolocation: nd_geolocation.description; only if the ND Experiment storage
 *        method is chosen.
 */

function genotypes_loader_load_legacy($input_file = NULL, $samples, $options) {

  // TEST INPUTS. @TODO: Get these as options
  $options = array(
    'organism_id' => '4',
    'variant_type' => 'SNP',
    'feature_type_of_marker' => 'genetic_marker',
    'marker_type' => 'GBS',
    'project_name' => 'AGILE: Application of Genomic Innovation in the Lentil Economy',
    'storage_method' => 'nd_exp',
    'insert_samples' => '0',
    'insert_germplasm' => '0',
    'insert_markers' => '2',
    'insert_variants' => '2',
    'nd_geolocation' => '2C33',
  );

  // PROCESSING LEGACY FORMAT FILE
  // -----------------------------

  $total_lines = intval(exec("grep -vc '^#' $input_file"));
  // Setting this to 0 since we're counting number of lines with SNPs, not header lines.
  $num_lines = 0;
  // Start the progress bar
  $progress = genotypes_loader_print_progress($num_lines, $total_lines);
  print($progress);

  // Open our file
  $file = fopen($input_file, 'r') or die ("ERROR: Unable to open $input_file!");

  // Save the header
  $header = fgetcsv($file, 0, "\t");

  // For each line except for the header, process sample, variant, marker and genotype
  while(!feof($file)) {

    $current_line = fgetcsv($file, 0, "\t");
    if (empty($current_line)) continue;

    // Use the header to create the keys for each marker array
    $marker = array_combine($header, $current_line);



  }

